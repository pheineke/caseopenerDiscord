<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Base{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    {% block head %}{% endblock %}
</head>
<body class="app-shell" data-logged-in="{{ '1' if session.get('user_id') else '0' }}">
    <header class="site-header">
        <nav class="nav-bar">
                        <div class="nav-brand"><a href="{{ url_for('home') if session.get('user_id') else url_for('login') }}" style="text-decoration:none;color:inherit;">CaseOpener</a></div>
            <div class="nav-spacer"></div>
                                                <div class="nav-actions">
                                {% if session.get('user_id') %}
                                    <a class="nav-link" href="{{ url_for('case_selector') }}">Cases</a>
                                    <a class="nav-link" href="{{ url_for('inventory_page') }}">Inventory</a>
                                    <a class="nav-link" href="{{ url_for('friends') }}">Friends</a>
                                {% endif %}
                                                                {% block nav_actions %}{% endblock %}
                                                                                                                                {% if current_user %}
                                                                                                                                                                        <div class="avatar-link" id="avatarMenu">
                                                                                                                                                                            <img class="avatar-menu-trigger" src="{{ avatar_url(current_user) }}" alt="avatar" style="width:34px;height:34px;border-radius:50%;object-fit:cover;border:1px solid #2f4761;box-shadow:0 0 0 1px rgba(63,169,245,.15);background:linear-gradient(135deg,#263347,#1d2738);">
                                                                                                                                        <div class="avatar-dropdown" id="avatarDropdown">
                                                                                                                                            <div class="avatar-username">{{ current_user.username }}</div>
                                                                                                                                            <a href="{{ url_for('profile') }}">Profile</a>
                                                                                                                                            <a href="{{ url_for('logout') }}">Logout</a>
                                                                                                                                        </div>
                                                                                                                                    </div>
                                                                                                                                {% endif %}
                                                </div>
        </nav>
    </header>
    {# Global overlay flash region (removed from main to avoid layout shift) #}
    {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
    <div class="flash-stack" role="status" aria-live="polite">
        {% for category, message in msgs %}
            {% set cat = category if category in ['success','error','info'] else 'info' %}
            <div class="flash surface flash-{{ cat }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <main>
        {% block content %}{% endblock %}
    </main>
    <footer>
        <span class="text-dim">&copy; {{ 2025 }} CaseOpener Simulator</span>
        <span style="margin-left:12px;opacity:.85">
            <a href="{{ url_for('tos') }}">Terms</a> Â·
            <a href="{{ url_for('privacy') }}">Privacy</a>
        </span>
    </footer>
    <script>
    // Discord Embedded App SDK bootstrap (safe to load even outside Discord)
    (function(){
        const urlHas = (k) => new URLSearchParams(location.search).has(k);
        const isFramed = (() => { try { return window.top !== window; } catch { return true; } })();
        const isDiscordRef = /discord/i.test(document.referrer || '');
        const looksLikeActivity = urlHas('instance_id') || urlHas('platform');
        const isInDiscord = isFramed && (isDiscordRef || looksLikeActivity);
        if (!isInDiscord) return;
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@discord/embedded-app-sdk@^1/dist/index.global.js';
        s.async = true;
    s.onload = async () => {
            try {
                const { discordSdk } = window;
                await discordSdk.ready();
                // Request OAuth2 code for our app; server will exchange it for a token
                const { code } = await discordSdk.commands.authorize({
                    client_id: '{{ discord_app_id }}',
                    response_type: 'code',
                    state: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2),
                    prompt: 'none',
                    scope: ['identify']
                });
                const resp = await fetch('/discord/exchange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ code })
                });
                const token = await resp.json();
                window.__discordToken = token;
                // Example: fetch basic user via RPC (no network)
                try {
                    const me = await discordSdk.commands.getCurrentUser();
                    window.__discordUser = me;
                    // If user isn't logged in to the site, create/link account on the server
                    const loggedIn = document.body.getAttribute('data-logged-in') === '1';
                    if (!loggedIn) {
                        await fetch('/auth/discord', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                id: me.id,
                                username: me.username,
                                global_name: me.global_name,
                                avatar: me.avatar ? `https://cdn.discordapp.com/avatars/${me.id}/${me.avatar}.png` : undefined
                            })
                        });
                        // Ensure next navigation reflects logged-in header state
                        location.reload();
                    }
                } catch {}
            } catch (err) {
                console.warn('Discord SDK init failed', err);
            }
        };
        document.head.appendChild(s);
    })();
    (function(){
        const menu = document.getElementById('avatarMenu');
        if(!menu) return;
        const trigger = menu.querySelector('.avatar-menu-trigger');
        function close(){ menu.classList.remove('open'); }
        function toggle(e){
            e.stopPropagation();
            menu.classList.toggle('open');
        }
        trigger.addEventListener('click', toggle);
        document.addEventListener('click', (e)=>{ if(!menu.contains(e.target)) close(); });
        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close(); });
    })();
    // Auto dismiss flash messages
    (function(){
        const flashes = document.querySelectorAll('.flash');
        flashes.forEach((el,i)=>{
            setTimeout(()=>{ el.classList.add('fade'); setTimeout(()=>el.remove(), 600); }, 3800 + i*250);
        });
    })();
    </script>
</body>
</html>